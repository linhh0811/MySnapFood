@page "/bills/user/{id:guid}"
@using Service.SnapFood.Manage.Dto
@using Service.SnapFood.Manage.Dto.Bill
@using Service.SnapFood.Manage.Dto.BillDetails
@using Service.SnapFood.Manage.Enums
@using Service.SnapFood.Manage.Infrastructure.Services
@using Service.SnapFood.Share.Interface.Extentions
@using Service.SnapFood.Share.Model.Enum
@using Service.SnapFood.Share.Model.Result
@using Service.SnapFood.Share.Model.ServiceCustomHttpClient
@inject HttpClient Http

<h3>Chi tiết đơn hàng</h3>

@if (Item.PhuongThucDatHang == PhuongThucDatHangEnum.DatTaiWeb && Item.ReceivingType == ReceivingType.HomeDelivery)
{
    <div class="step-container @(Item.Status == StatusOrder.Cancelled ? "cancelled" : "")">

        <div class="step @(currentStep >= 1 ? "active" : "")">
            <div class="circle">1</div>
            <div class="step-label">Chờ xác nhận</div>
        </div>
        <div class="step @(currentStep >= 3 ? "active" : "")">
            <div class="circle">2</div>
            <div class="step-label">Đang chuẩn bị</div>
        </div>
        <div class="step @(currentStep >= 4 ? "active" : "")">
            <div class="circle">3</div>
            <div class="step-label">Giao hàng</div>
        </div>
        <div class="step @(currentStep >= 5 ? "active" : "")">
            <div class="circle">4</div>
            <div class="step-label">Hoàn thành</div>
        </div>
        <div class="step @(Item.Status == StatusOrder.Cancelled ? "active" : "")">
            <div class="circle">5</div>
            <div class="step-label">Huỷ</div>
        </div>

    </div>

    <div class="mb-3">
        @if (Item.Status == StatusOrder.Pending)
        {
            <FluentButton Appearance="Appearance.Accent" @onclick="OpenHoaDonModal" IconStart="@(new Icons.Regular.Size20.CheckmarkCircle())">Xác nhận</FluentButton>
            <FluentButton BackgroundColor="red" Appearance="Appearance.Accent" Color="White" @onclick="HuyDonHangAsync" IconStart="@(new Icons.Regular.Size20.DismissCircle())">Huỷ</FluentButton>
        }
        else if (Item.Status == StatusOrder.DangChuanBi)
        {
            <FluentButton Appearance="Appearance.Accent" @onclick="() => UpdateStatus(StatusOrder.Shipping)" IconStart="@(new Icons.Regular.Size20.BoxCheckmark())">Đã chuẩn bị xong</FluentButton>
            <FluentButton BackgroundColor="red" Appearance="Appearance.Accent" Color="White" @onclick="HuyDonHangAsync" IconStart="@(new Icons.Regular.Size20.DismissCircle())">Huỷ</FluentButton>
        }
        else if (Item.Status == StatusOrder.Shipping)
        {
            <FluentButton Appearance="Appearance.Accent" @onclick="() => UpdateStatus(StatusOrder.Completed)" IconStart="@(new Icons.Regular.Size20.CheckmarkCircle())">Hoàn thành</FluentButton>
            <FluentButton BackgroundColor="Red" Appearance="Appearance.Accent"  Color="White" @onclick="HuyDonHangAsync" IconStart="@(new Icons.Regular.Size20.DismissCircle())">Huỷ</FluentButton>
        }
    </div>
}
else if (Item.PhuongThucDatHang == PhuongThucDatHangEnum.DatTaiWeb && Item.ReceivingType == ReceivingType.PickUpAtStore)
{
    <div class="step-container @(Item.Status == StatusOrder.Cancelled ? "cancelled" : "")">

        <div class="step @(currentStep >= 1 ? "active" : "")">
            <div class="circle">1</div>
            <div class="step-label">Chờ xác nhận</div>
        </div>
        <div class="step @(currentStep >= 3 ? "active" : "")">
            <div class="circle">2</div>
            <div class="step-label">Đang đang chuẩn bị</div>
        </div>
        <div class="step @(currentStep >= 4 ? "active" : "")">
            <div class="circle">3</div>
            <div class="step-label">Chờ nhận hàng</div>
        </div>
        <div class="step @(currentStep >= 5 ? "active" : "")">
            <div class="circle">4</div>
            <div class="step-label">Hoàn thành</div>
        </div>
        <div class="step @(Item.Status == StatusOrder.Cancelled ? "active" : "")">
            <div class="circle">5</div>
            <div class="step-label">Huỷ</div>
        </div>

    </div>

    <div class="mb-3">
        @if (Item.Status == StatusOrder.Pending)
        {
            <FluentButton Appearance="Appearance.Accent" @onclick="OpenHoaDonModal" IconStart="@(new Icons.Regular.Size20.CheckmarkCircle())">Xác nhận</FluentButton>
            <FluentButton BackgroundColor="red" Appearance="Appearance.Accent" Color="White" @onclick="HuyDonHangAsync" IconStart="@(new Icons.Regular.Size20.DismissCircle())">Huỷ</FluentButton>
        }
        else if (Item.Status == StatusOrder.DangChuanBi)
        {
            <FluentButton Appearance="Appearance.Accent" @onclick="() => UpdateStatus(StatusOrder.ChoLayHang)" IconStart="@(new Icons.Regular.Size20.BoxCheckmark())">Đã chuẩn bị xong</FluentButton>
            <FluentButton BackgroundColor="red" Appearance="Appearance.Accent" Color="White" @onclick="HuyDonHangAsync" IconStart="@(new Icons.Regular.Size20.DismissCircle())">Huỷ</FluentButton>
        }
        else if (Item.Status == StatusOrder.ChoLayHang)
        {
            <FluentButton Appearance="Appearance.Accent" @onclick="() => UpdateStatus(StatusOrder.Completed)" IconStart="@(new Icons.Regular.Size20.CheckmarkCircle())">Khách hàng đã nhận hàng</FluentButton>
            <FluentButton BackgroundColor="Red" Appearance="Appearance.Accent" Color="White" @onclick="HuyDonHangAsync" IconStart="@(new Icons.Regular.Size20.DismissCircle())">Huỷ</FluentButton>
        }
    </div>
}
else if (Item.PhuongThucDatHang == PhuongThucDatHangEnum.DatTaiQuay)
{
    <div class="step-container @(Item.Status == StatusOrder.Cancelled ? "cancelled" : "")">


        <div class="step @(currentStep >= 3 ? "active" : "")">
            <div class="circle">1</div>
            <div class="step-label">Đang chuẩn bị</div>
        </div>

        <div class="step @(currentStep >= 5 ? "active" : "")">
            <div class="circle">2</div>
            <div class="step-label">Hoàn thành</div>
        </div>
        <div class="step @(Item.Status == StatusOrder.Cancelled ? "active" : "")">
            <div class="circle">3</div>
            <div class="step-label">Huỷ</div>
        </div>

    </div>

    <div class="mb-3">

        @if (Item.Status == StatusOrder.DangChuanBi)
        {
            <FluentButton Appearance="Appearance.Accent" @onclick="() => UpdateStatus(StatusOrder.Completed)" IconStart="@(new Icons.Regular.Size20.CheckmarkCircle())">Hoàn thành</FluentButton>
            <FluentButton BackgroundColor="red" Appearance="Appearance.Accent" Color="White" @onclick="HuyDonHangAsync" IconStart="@(new Icons.Regular.Size20.DismissCircle())">Huỷ</FluentButton>
        }

    </div>
}



<div class="order-info">
    <div class="row">
        <!-- Bên trái -->
        <div class="col-md-6 left">
            <p><strong>@Item.BillDeliveryDto.ReceiverName</strong></p>
            <p>@Item.BillDeliveryDto.ReceiverAddress</p>
            @if (!string.IsNullOrEmpty(@Item.BillDeliveryDto.ReceiverPhone))
            {
                <p>Điện thoại: @Item.BillDeliveryDto.ReceiverPhone</p>
            }

        </div>

        <!-- Bên phải -->
        <div class="col-md-6 right">
            <p><span class="label">Mã đơn hàng: </span><span class="order-id">@Item.BillCode</span></p>
            <p><span class="label">Thời gian đặt: </span>@Item.Created.ToString("dd/MM/yyyy HH:mm")</p>
            <p><span class="label">Phương thức đặt hàng: </span>@Item.PhuongThucDatHang.GetDescription()</p>

            <p><span class="label">Hình thức thanh toán: </span>@Item.BillPaymentDto.PaymentType.GetDescription()</p>
            <p><span class="label">Hình thức nhận hàng: </span>@Item.ReceivingType.GetDescription()</p>

        </div>
    </div>
</div>

<!-- DANH SÁCH MÓN ĂN -->
@if (!Item.BillDetailsDtos.Any())
{
    <p>Không tìm thấy đơn hàng.</p>
}
else
{
    <div style="margin-top: 16px">
        <FluentDataGrid Items="@Item.BillDetailsDtos.AsQueryable()"
        TGridItem="BillDetailsDto"
        GridTemplateColumns="0.75fr 1.45fr 0.75fr 0.75fr 0.75fr"
        ResizableColumns="false"
        MultiLine="true"
        ShowHover="true">
            <ChildContent>
                <TemplateColumn Title="Hình ảnh" Style="display:flex;align-items:center;">
                    <img src="@context.ImageUrl" style="max-height:60px;max-width:70px;object-fit:contain;" />
                </TemplateColumn>
                <TemplateColumn Title="Tên" Style="display: flex; flex-direction: column; justify-content: center;">
                    <span style="font-size:16px;">
                        @context.ItemsName
                    </span>
                    @if (context.ItemType == ItemType.Combo && context.Product is not null)
                    {
                        <div style="max-height: 80px; overflow-y: auto; display: flex; flex-direction: column; gap: 4px; color: gray;padding-left:20px;">
                            @foreach (var item in context.Product)
                            {
                                <div style="cursor: pointer;font-size:12px;">
                                    @item.ProductName
                                </div>
                            }
                        </div>
                    }
                </TemplateColumn>
                <TemplateColumn Title="Giá" Style="display: flex; flex-direction: column; justify-content: center;">
                    @if (context.PriceEndow > 0)
                    {
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <FluentLabel Style="text-decoration: line-through;font-size:12px;">
                                @context.Price.ToString("N0") đ
                            </FluentLabel>
                            @if (context.Price > context.PriceEndow)
                            {
                                var discountPercent = Math.Round(((context.Price - context.PriceEndow) / context.Price) * 100);
                                <FluentLabel Style="color: green;font-size:12px;">
                                    -@discountPercent %
                                </FluentLabel>
                            }
                        </div>
                        <FluentLabel>@context.PriceEndow.ToString("N0") đ</FluentLabel>
                    }
                    else
                    {
                        <FluentLabel>@context.Price.ToString("N0") đ</FluentLabel>
                    }
                </TemplateColumn>
                <TemplateColumn Title="Số lượng" Style="display:flex;align-items:center;gap:5px;">
                    @context.Quantity
                </TemplateColumn>
                <TemplateColumn Title="Tổng" Style="display: flex; flex-direction: column; justify-content: center;">
                    @if (context.PriceEndow > 0)
                    {
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <FluentLabel Style="text-decoration: line-through;font-size:12px;">
                                @((context.Price * context.Quantity).ToString("N0")) đ
                            </FluentLabel>
                            @if (context.Price > context.PriceEndow)
                            {
                                var discountPercent = Math.Round(((context.Price - context.PriceEndow) / context.Price) * 100);
                                <FluentLabel Style="color: green;font-size:12px;">
                                    -@discountPercent %
                                </FluentLabel>
                            }
                        </div>
                        <FluentLabel>@((context.PriceEndow * context.Quantity).ToString("N0")) đ</FluentLabel>
                    }
                    else
                    {
                        <FluentLabel>@((context.Price * context.Quantity).ToString("N0")) đ</FluentLabel>
                    }
                </TemplateColumn>
            </ChildContent>
        </FluentDataGrid>
    </div>
    <div class="row">
        <div class="col-8" style="margin-top: 20px;">
            @foreach (var item in Item.BillNotesDtos)
            {
                <div style="display: flex; justify-content: flex-start;@(item.NoteContent.Contains("hủy")?"color:red":"")">
                    <p style="min-width: 120px; text-align: left;">@(item.NoteType == NoteType.CustomerOrder ? "Khách hàng" : "Cửa hàng"): </p>
                    <p style="width:200px;">@item.Created.ToString("dd/MM/yyyy HH:mm:ss")</p>
                    <p style="width:100%;">@item.NoteContent</p>
                </div>
            }
        </div>
        <div class="col-4" style="margin-top: 20px; text-align: right;">
            <div style="display: flex; justify-content: flex-end;">
                <p style="min-width: 120px; text-align: left;">Tạm tính:</p>
                <p style="width:100px">@Item.TotalAmount.ToString("N0") đ</p>
            </div>
            <div style="display: flex; justify-content: flex-end;">
                <p style="min-width: 120px; text-align: left;">Khuyến mãi:</p>
                <p style="width:100px">@Item.TotalAmountEndow.ToString("N0") đ</p>
            </div>
            <div style="display: flex; justify-content: flex-end;">
                <p style="min-width: 120px; text-align: left;">Mã giảm giá:</p>
                <p style="width:100px">@Item.DiscountAmount.ToString("N0") đ</p>
            </div>
            <div style="display: flex; justify-content: flex-end;">
                <p style="min-width: 120px; text-align: left;">Phí vận chuyển:</p>
                <p style="width:100px">@Item.BillDeliveryDto.DeliveryFee.ToString("N0") đ</p>
            </div>
            <div style="display: flex;font-size: 18px; justify-content: flex-end;">
                <p style="min-width: 120px; text-align: left;">Tổng cộng:</p>
                <p style="width:100px">@((Item.TotalAmount + Item.BillDeliveryDto.DeliveryFee - Item.DiscountAmount - Item.TotalAmountEndow).ToString("N0")) đ</p>
            </div>
        </div>
    </div>

}

<style>
    .step-container {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 10px 20px;
    border: 1px solid #ddd;
    border-radius: 10px;
    background: #fff;
    margin-bottom: 20px;
    position: relative;
    }

    .step {
    display: flex;
    flex-direction: column;
    align-items: center;
    flex: 1;
    position: relative;
    }

    .step:not(:first-child)::after {
    content: "";
    position: absolute;
    top: 17px;
    right: 50%;
    width: 100%;
    height: 3px;
    background-color: #ddd;
    z-index: 0;
    }

    .step.active:not(:first-child)::after {
    background-color: #007bff;
    }

    .step-container.cancelled .step.active:not(:first-child)::after {
    background-color: #dc3545;
    }

    .circle {
    width: 35px;
    height: 35px;
    border-radius: 50%;
    background-color: #ddd;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    z-index: 1;
    position: relative;
    }

    .step.active .circle {
    background-color: #007bff;
    }

    .step-container.cancelled .step.active .circle {
    background-color: #dc3545;
    }

    .step-label {
    margin-top: 5px;
    font-size: 16px;
    color: #333;
    }

    .step-container.cancelled .step.active .step-label {
    color: #dc3545;
    }

    /* Ensure the line stops at the current step */
    .step:last-child.active ~ .step::after {
    background-color: #ddd;
    }
</style>

@code {
    [Parameter] public Guid id { get; set; }
    [Inject] protected ICallServiceRegistry CallApi { get; set; } = default!;
    [Inject] private IToastService ToastService { get; set; } = default!;
    [Inject] private IDialogService DialogService { get; set; } = default!;

    private BillViewDto Item = new();
    int currentStep = 0;

    protected override async Task OnInitializedAsync()
    {
        await LoadItem();
    }

    private async Task LoadItem()
    {
        var request = new ApiRequestModel { Endpoint = $"api/Bill/DetailsByBillId/{id}" };
        var result = await CallApi.Get<BillViewDto>(request);
        if (result.Status == StatusCode.OK)
        {
            Item = result.Data as BillViewDto ?? new BillViewDto();
            currentStep = ConvertStatusToStep(Item.Status);
        }
    }

    private int ConvertStatusToStep(StatusOrder status)
    {
        return status switch
        {
            StatusOrder.Pending => 1, // Pending
            // StatusOrder.Confirmed => 2, // Confirmed
            StatusOrder.DangChuanBi => 3, // Confirmed

            StatusOrder.Shipping => 4, // Shipping
            StatusOrder.ChoLayHang => 4, // chờ lấy hàng

            StatusOrder.Completed => 5, // Completed
            StatusOrder.Cancelled => 6, // Cancelled
            _ => 1
        };
    }

    private async Task UpdateStatus(StatusOrder status, string reason = "")
    {
        try
        {
            var request = new ApiRequestModel { Endpoint = $"api/Bill/UpdateStatus/{id}" };
            var updateDto = new UpdateOrderStatusDto
                {
                    StatusOrder = status,
                    Reason = reason
                };

            ResultAPI result = await CallApi.Put(request, updateDto);
            if (result.Status == StatusCode.OK)
            {
                await LoadItem();
                StateHasChanged();
            }

        }
        catch (Exception ex)
        {
            ToastService.ShowError("Thao tác thất bại: " + ex.Message);
        }
    }
    private async Task HuyDonHangAsync()
    {
        try
        {
            var dialog = await DialogService.ShowDialogAsync<HuyDonHangConfirm>(new DialogParameters());
            var resultDialog = await dialog.Result;
            if (resultDialog.Cancelled == false && resultDialog.Data is HuyDonHangConfirmResult result && result.Success)
            {
                // Sử dụng result.Reason để gửi lên API
                await UpdateStatus(StatusOrder.Cancelled, result.Reason);
            }
        }
        catch (Exception ex)
        {
            ToastService.ShowError("Xóa thất bại: " + ex.Message);
        }

    }

    private async Task OpenHoaDonModal()
    {
        try
        {
            if (id != Guid.Empty)
            {
                var parameters = new InHoaDonParameter
                {
                    Id = id,
                    OnRefresh = EventCallback.Factory.Create(this, LoadItem)
                };
                await DialogService.ShowDialogAsync<Pdf.Index>(parameters, new DialogParameters
                {
                    Title = "Hóa đơn",
                    PreventDismissOnOverlayClick = true,
                    PreventScroll = true,
                    Modal = true,
                    Width = "900px",
                    TrapFocus = false

                });
            }
           
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Lỗi khi mở modal chi tiết: {ex.Message}");
        }
    }

}