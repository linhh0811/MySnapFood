@page "/Gio-Hang"
@inherits CartBase
@using Service.SnapFood.Client.Dto.Cart
@using Microsoft.FluentUI.AspNetCore.Components
@using Microsoft.FluentUI.AspNetCore.Components.Icons
@using Service.SnapFood.Client.Enums
@using Service.SnapFood.Client.Infrastructure.Service

<h3 style="margin-top:30px;z-index:2">Giỏ hàng của bạn</h3>

@if (isLoading)
{
    <div class="loading-center">
        Đang tải...
    </div>
}
else
{


    @if (CartModel == null || !CartModel.CartItems.Any())
    {
        <p>Giỏ hàng của bạn trống.</p>
        <FluentButton Appearance="Appearance.Accent" @onclick="NavigateToOrderHome">
            Quay lại mua sắm
        </FluentButton>
    }
    else
    {
        <div class="row mb-2">
            <div class="col-lg-9">
                <div class="card shadow">
                    <div class="card-body">

                    
                    <FluentDataGrid Items="@CartModel.CartItems.AsQueryable()"
                                    TGridItem="CartItemDto"
                                    GridTemplateColumns="0.45fr 0.75fr 1.45fr 0.75fr 0.9fr 0.75fr 0.4fr"
                                    ResizableColumns="false"
                                    MultiLine="true"
                                    ShowHover="true">
                        <ChildContent>
                            <TemplateColumn Title="#" Style="display:flex;align-items:center;">
                                <span>@(CartModel.CartItems.IndexOf(context) + 1)</span>
                            </TemplateColumn>
                            <TemplateColumn Title="Hình ảnh" Style="display:flex;align-items:center;">
                                <img src="@context.ImageUrl" style="max-height:60px;max-width:70px;object-fit:contain;" alt="@context.ItemName" />
                            </TemplateColumn>
                            <TemplateColumn Title="Tên" Style="display: flex; flex-direction: column; justify-content: center;">
                                <span style="font-size:16px;">
                                    @context.ItemName
                                </span>
                                @if (context.ItemType == ItemType.Product)
                                {
                                    <div style="max-height: 80px; overflow-y: auto; display: flex; flex-direction: column; gap: 4px; color: gray;padding-left:20px;">
                                        <div style="cursor: pointer;font-size:12px;">
                                            Kích thước:  @context.SizeName
                                        </div>
                                    </div>
                                }
                                @if (context.ItemType == ItemType.Combo)
                                {
                                    <div style="max-height: 80px; overflow-y: auto; display: flex; flex-direction: column; gap: 4px; color: gray;padding-left:20px;">
                                        @foreach (var item in context.ComboItems)
                                        {
                                            <div style="cursor: pointer;font-size:12px;">
                                                @item.ProductName (@item.SizeName)
                                            </div>
                                        }
                                    </div>
                                }
                            </TemplateColumn>
                            <TemplateColumn Title="Giá" Style="display: flex; flex-direction: column; justify-content: center;">
                                @if (context.PriceEndown > 0)
                                {
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <FluentLabel Style="text-decoration: line-through;font-size:12px;">
                                            @context.BasePrice.ToString("N0") đ
                                        </FluentLabel>

                                        @if (context.BasePrice > context.PriceEndown)
                                        {
                                            var discountPercent = Math.Round(((context.BasePrice - context.PriceEndown) / context.BasePrice) * 100);
                                            <FluentLabel Style="color: green;font-size:12px;">
                                                -@discountPercent %
                                            </FluentLabel>
                                        }
                                    </div>
                                    <FluentLabel>@context.PriceEndown.ToString("N0") đ</FluentLabel>
                                }
                                else
                                {
                                    <FluentLabel>@context.BasePrice.ToString("N0") đ</FluentLabel>
                                }
                            </TemplateColumn>
                            <TemplateColumn Title="Số lượng" Style="display:flex;align-items:center;gap:5px;">
                                <FluentButton Appearance="Appearance.Outline" Style="width: 30px; height: 30px; background-color: #FF969A; color: white;" Onclick="()=>DecreaseQuantity(context.Id,context.ItemType,context.Quantity)" Disabled="IsUpdateQuantity" Title="Giảm số lượng">
                                    <FluentIcon Value="@(new Icons.Regular.Size16.Subtract())"
                                                Color="@Color.Neutral" />
                                </FluentButton>
                                <FluentLabel Style="width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; border: 1px solid #ccc; border-radius: 4px;">@context.Quantity</FluentLabel>
                                <FluentButton Appearance="Appearance.Outline" Style="width: 30px; height: 30px; background-color: #FF969A; color: white;" Onclick="()=>IncreaseQuantity(context.Id,context.ItemType)" Disabled="IsUpdateQuantity" Title="Thêm số lượng">
                                    <FluentIcon Value="@(new Icons.Regular.Size16.Add())" Color="@Color.Neutral" />
                                </FluentButton>
                            </TemplateColumn>
                            <TemplateColumn Title="Tổng" Style="display: flex; flex-direction: column; justify-content: center;">
                                @if (context.PriceEndown > 0)
                                {
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <FluentLabel Style="text-decoration: line-through;font-size:12px;">
                                            @((context.BasePrice * context.Quantity).ToString("N0")) đ
                                        </FluentLabel>

                                        @if (context.BasePrice > context.PriceEndown)
                                        {
                                            var discountPercent = Math.Round(((context.BasePrice - context.PriceEndown) / context.BasePrice) * 100);
                                            <FluentLabel Style="color: green;font-size:12px;">
                                                -@discountPercent %
                                            </FluentLabel>
                                        }
                                    </div>
                                    <FluentLabel>@((context.PriceEndown * context.Quantity).ToString("N0")) đ</FluentLabel>
                                }
                                else
                                {
                                    <FluentLabel>@((context.BasePrice * context.Quantity).ToString("N0")) đ</FluentLabel>
                                }

                            </TemplateColumn>
                            <TemplateColumn Style="display:flex;align-items:center;">
                                <FluentButton OnClick="()=>RemoveItem(context.Id,context.ItemType)" Title="Gỡ khỏi giỏ hàng">
                                    <FluentIcon Value="@(new Icons.Regular.Size20.Delete())" Color="@Color.Neutral" />
                                </FluentButton>
                            </TemplateColumn>
                        </ChildContent>
                    </FluentDataGrid>
                    </div>
                </div>

            </div>
            <div class="col-lg-3">
                <div style="display: flex; flex-direction: column; gap: 12px; width: 100%;">

                    <div style="font-weight: bold; font-size: 16px;">Phương thức nhận hàng</div>

                    <label style="border: @(GetBorderStyle("Nhan-Tai-Quay")); border-radius: 8px; padding: 12px; cursor: pointer; display: flex; align-items: center; gap: 10px;" @onclick="@(()=>PhuongThucNhanHangClick("Nhan-Tai-Quay"))">
                        <input type="radio" name="deliveryMethod" value="Nhan-Tai-Quay" checked style="accent-color: #FF969A;" />
                        🏪 Nhận tại quầy
                    </label>

                    <label style="border: @(GetBorderStyle("Giao-Tan-Noi")); border-radius: 8px; padding: 12px; cursor: pointer; display: flex; align-items: center; gap: 10px;" @onclick="@(()=>PhuongThucNhanHangClick("Giao-Tan-Noi"))">
                        <input type="radio" name="deliveryMethod" value="Giao-Tan-Noi" style="accent-color: #FF969A;" />
                        🚚 Giao tận nơi
                    </label>

                </div>

                <div style="width: 100%; border-radius: 12px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); overflow: hidden; background-color: white;margin-top: 20px;">
                    <div style="padding: 16px; font-size: 16px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 12px; color: #1d293f;">
                            <span>Tổng</span>
                            <span>@totalPrice.ToString("N0") đ</span>
                        </div>
                        @if (totalPriceEndown > 0)
                        {
                            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; color: #1d293f;">
                                <span>Khuyến mãi</span>
                                <span>-@totalPriceEndown.ToString("N0") đ</span>
                            </div>
                        }

                        <hr style="border: none; border-top: 1px dashed #ff969a; margin-bottom: 12px;" />
                        <div style="display: flex; justify-content: space-between; font-weight: bold; font-size: 18px; color: #1d293f;">
                            <span>Tạm tính</span>
                            <span>@((totalPrice - totalPriceEndown).ToString("N0")) đ</span>
                        </div>
                    </div>
                    <button style="background-color: #ff5961; color: white; width: 100%; padding: 14px 0; font-size: 16px; font-weight: bold; border: none; cursor: pointer;" @onclick="CheckOut">
                        Tiếp tục
                    </button>
                </div>
            </div>
        </div>
    }
}

